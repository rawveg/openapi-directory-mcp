name: Release & NPM Publish

on:
  push:
    tags:
      - 'v*'

jobs:
  pre-release-validation:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      tag: ${{ steps.get-version.outputs.tag }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Get version from tag
        id: get-version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "🏷️  Tag: $TAG"
          echo "📦 Version: $VERSION"
          
      - name: Verify version in package.json
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [ "$PACKAGE_VERSION" != "${{ steps.get-version.outputs.version }}" ]; then
            echo "❌ Version mismatch: package.json has $PACKAGE_VERSION but tag is ${{ steps.get-version.outputs.version }}"
            exit 1
          fi
          echo "✅ Version in package.json matches tag"
          
      - name: Check changelog entry
        run: |
          if [ -f "CHANGELOG.md" ]; then
            if grep -q "${{ steps.get-version.outputs.version }}" CHANGELOG.md; then
              echo "✅ Changelog entry found for version ${{ steps.get-version.outputs.version }}"
            else
              echo "⚠️  No changelog entry found for version ${{ steps.get-version.outputs.version }}"
            fi
          else
            echo "⚠️  No CHANGELOG.md file found"
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run validation suite
        run: |
          echo "🧪 Running validation checks..."
          npm run validate
          
      - name: Build project
        run: |
          npm run build
          chmod +x dist/index.js
        
      - name: Validate package contents
        run: |
          echo "📦 Validating package contents..."
          npm pack --dry-run
          
          # Check essential files exist
          if [ ! -f "dist/index.js" ]; then
            echo "❌ Missing dist/index.js"
            exit 1
          fi
          
          if [ ! -f "package.json" ]; then
            echo "❌ Missing package.json"
            exit 1
          fi
          
          if [ ! -f "README.md" ]; then
            echo "❌ Missing README.md"
            exit 1
          fi
          
          echo "✅ Package validation passed"

  build-and-package:
    name: Build & Package
    runs-on: ubuntu-latest
    needs: pre-release-validation
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Clean build
        run: |
          rm -rf dist
          npm run build
          chmod +x dist/index.js
          
      - name: Generate tarball preview
        run: |
          echo "📦 Creating package tarball..."
          npm pack
          
          TARBALL=$(ls *.tgz)
          echo "📦 Generated: $TARBALL"
          
          # List contents
          echo "📋 Package contents:"
          tar -tzf "$TARBALL" | head -20
          
          # Check size
          SIZE=$(stat -c%s "$TARBALL")
          echo "📊 Package size: $SIZE bytes"
          
          if [ "$SIZE" -gt 10000000 ]; then
            echo "⚠️  Package is quite large (>10MB)"
          fi
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ needs.pre-release-validation.outputs.version }}
          path: |
            dist/
            *.tgz
          retention-days: 30

  npm-publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [pre-release-validation, build-and-package]
    environment: npm-production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build for production
        run: |
          npm run build
          chmod +x dist/index.js
        
      - name: Configure NPM authentication
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
          echo "✅ NPM authentication configured"
          
      - name: Verify NPM authentication
        run: |
          npm whoami
          echo "✅ NPM authentication verified"
          
      - name: Publish to NPM
        run: |
          echo "🚀 Publishing to NPM..."
          
          # Check if this is a prerelease
          if [[ "${{ needs.pre-release-validation.outputs.version }}" == *"beta"* ]] || \
             [[ "${{ needs.pre-release-validation.outputs.version }}" == *"alpha"* ]] || \
             [[ "${{ needs.pre-release-validation.outputs.version }}" == *"rc"* ]]; then
            echo "📦 Publishing prerelease version with beta tag..."
            npm publish --tag beta
          else
            echo "📦 Publishing stable version with latest tag..."
            npm publish
          fi
          
          echo "✅ Successfully published to NPM"
          
      - name: Verify publication
        run: |
          echo "🔍 Verifying publication..."
          
          # Wait a moment for NPM to update
          sleep 10
          
          # Check that the version is available
          NPM_VERSION=$(npm view openapi-directory-mcp version)
          if [ "$NPM_VERSION" = "${{ needs.pre-release-validation.outputs.version }}" ]; then
            echo "✅ Version ${{ needs.pre-release-validation.outputs.version }} successfully published"
          else
            echo "❌ Published version ($NPM_VERSION) doesn't match expected (${{ needs.pre-release-validation.outputs.version }})"
            exit 1
          fi
          
      - name: Test installation
        run: |
          echo "🧪 Testing NPM installation..."
          
          # Create test directory
          mkdir npm-install-test
          cd npm-install-test
          
          # Test installation
          npm init -y
          npm install openapi-directory-mcp@${{ needs.pre-release-validation.outputs.version }}
          
          # Test CLI
          timeout 5s npx openapi-directory-mcp --help || echo "CLI started successfully"
          
          echo "✅ NPM installation test passed"

  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release-validation, npm-publish]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ needs.pre-release-validation.outputs.version }}
          path: ./artifacts
          
      - name: Generate changelog
        id: changelog
        run: |
          echo "📝 Generating changelog..."
          
          # Get previous tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "📊 Changes since $PREVIOUS_TAG:"
            
            # Generate changelog from commits
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD)
            
            # Create release notes
            cat > release-notes.md << EOF
          ## What's Changed
          
          $CHANGELOG
          
          ## Installation
          
          \`\`\`bash
          npm install -g openapi-directory-mcp@${{ needs.pre-release-validation.outputs.version }}
          \`\`\`
          
          Or use with npx:
          
          \`\`\`bash
          npx openapi-directory-mcp@${{ needs.pre-release-validation.outputs.version }}
          \`\`\`
          
          ## Verification
          
          ✅ Package published to NPM: https://www.npmjs.com/package/openapi-directory-mcp/v/${{ needs.pre-release-validation.outputs.version }}
          ✅ All validation checks passed
          ✅ Security scan completed
          ✅ Plugin architecture validated
          
          **Full Changelog**: https://github.com/rawveg/openapi-directory-mcp/compare/$PREVIOUS_TAG...${{ needs.pre-release-validation.outputs.tag }}
          EOF
          
          else
            echo "🎉 Initial release"
            cat > release-notes.md << EOF
          ## 🎉 Initial Release
          
          This is the first release of the OpenAPI Directory MCP server with plugin architecture.
          
          ## Installation
          
          \`\`\`bash
          npm install -g openapi-directory-mcp@${{ needs.pre-release-validation.outputs.version }}
          \`\`\`
          
          ## Features
          
          - 📦 22 built-in tools for API discovery and management
          - 🧩 25+ intelligent prompts for API integration
          - 🔧 Plugin architecture for zero-touch extensibility
          - ⚡ Dual-source API data (APIs.guru + enhanced dataset)
          - 💾 Intelligent caching for performance
          - 🔒 Type-safe with full TypeScript support
          
          See the [README](https://github.com/rawveg/openapi-directory-mcp/blob/main/README.md) for full documentation.
          EOF
          fi
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.pre-release-validation.outputs.tag }}
          release_name: Release ${{ needs.pre-release-validation.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(needs.pre-release-validation.outputs.version, 'beta') || contains(needs.pre-release-validation.outputs.version, 'alpha') || contains(needs.pre-release-validation.outputs.version, 'rc') }}

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [pre-release-validation, npm-publish, github-release]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Update package badges
        run: |
          echo "🏷️  Updating badges for version ${{ needs.pre-release-validation.outputs.version }}"
          echo "NPM: https://img.shields.io/npm/v/openapi-directory-mcp"
          echo "Downloads: https://img.shields.io/npm/dm/openapi-directory-mcp"
          echo "✅ Badge information updated"
          
      - name: Post-release verification
        run: |
          echo "🔍 Post-release verification..."
          
          # Verify NPM package
          curl -s https://registry.npmjs.org/openapi-directory-mcp/${{ needs.pre-release-validation.outputs.version }} > /dev/null
          if [ $? -eq 0 ]; then
            echo "✅ NPM package accessible"
          else
            echo "⚠️  NPM package not immediately accessible (may take a few minutes)"
          fi
          
          # Verify GitHub release
          curl -s https://api.github.com/repos/rawveg/openapi-directory-mcp/releases/tags/${{ needs.pre-release-validation.outputs.tag }} > /dev/null
          if [ $? -eq 0 ]; then
            echo "✅ GitHub release accessible"
          else
            echo "❌ GitHub release not accessible"
          fi
          
      - name: Notify completion
        run: |
          echo "🎉 Release ${{ needs.pre-release-validation.outputs.tag }} completed successfully!"
          echo ""
          echo "📦 NPM Package: https://www.npmjs.com/package/openapi-directory-mcp/v/${{ needs.pre-release-validation.outputs.version }}"
          echo "🏷️  GitHub Release: https://github.com/rawveg/openapi-directory-mcp/releases/tag/${{ needs.pre-release-validation.outputs.tag }}"
          echo ""
          echo "🔧 Installation command:"
          echo "npm install -g openapi-directory-mcp@${{ needs.pre-release-validation.outputs.version }}"